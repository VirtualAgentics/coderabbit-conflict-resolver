name: Version Bump

on:
  push:
    branches:
      - main

# Prevent overlapping version bumps
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  bump:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write  # Required for committing version bump
    # Skip if:
    # - Commit is from this workflow (prevent infinite loop via [skip bump])
    # - PR was from Renovate bot
    # - Commit message indicates dependency update (chore(deps) or deps:)
    if: |
      !contains(github.event.head_commit.message, '[skip bump]') &&
      !contains(github.event.head_commit.message, 'chore(deps)') &&
      !startsWith(github.event.head_commit.message, 'deps:') &&
      github.event.head_commit.author.name != 'renovate[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: "3.12"

      - name: Get PR info from merge commit
        id: pr
        run: |
          # Extract PR title and number from squash merge commit message
          # Format is typically: "PR Title (#123)"
          COMMIT_MSG=$(git log -1 --pretty=%s)

          # Extract PR number (last occurrence of #digits)
          PR_NUM=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | tail -1 | tr -d '#' || echo "")

          # Extract PR title (everything before the PR number reference)
          PR_TITLE=$(echo "$COMMIT_MSG" | sed 's/ (#[0-9]*)$//')

          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "Extracted: title='$PR_TITLE', number='$PR_NUM'"

      - name: Bump version
        id: bump
        run: |
          python scripts/bump_version.py
          NEW_VERSION=$(grep -oP '^version = "\K[^"]+' pyproject.toml)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped to version: $NEW_VERSION"

      - name: Update CHANGELOG
        run: |
          PR_TITLE="${{ steps.pr.outputs.title }}"
          PR_NUM="${{ steps.pr.outputs.number }}"
          DATE=$(date +%Y-%m-%d)
          VERSION="${{ steps.bump.outputs.new_version }}"

          # Create changelog entry with or without PR link
          if [ -n "$PR_NUM" ]; then
            ENTRY="* ${PR_TITLE} (#${PR_NUM})"
          else
            ENTRY="* ${PR_TITLE}"
          fi

          echo "Adding CHANGELOG entry: $ENTRY"

          python scripts/bump_version.py --changelog \
            --version "$VERSION" \
            --date "$DATE" \
            --entry "$ENTRY"

      - name: Commit and push
        env:
          NEW_VER: ${{ steps.bump.outputs.new_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email \
            "github-actions[bot]@users.noreply.github.com"

          git add pyproject.toml CHANGELOG.md \
            src/review_bot_automator/__init__.py
          git commit -m "chore: bump version to ${NEW_VER} [skip bump]"
          git push

      - name: Summary
        env:
          NEW_VER: ${{ steps.bump.outputs.new_version }}
          PR_TITLE: ${{ steps.pr.outputs.title }}
          PR_NUM: ${{ steps.pr.outputs.number }}
        run: |
          {
            echo "## Version Bump Complete"
            echo ""
            echo "**New Version:** ${NEW_VER}"
            echo ""
            echo "**Triggered by:** ${PR_TITLE}"
            if [ -n "${PR_NUM}" ]; then
              echo "**PR:** #${PR_NUM}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
