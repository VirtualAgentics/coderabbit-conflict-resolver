# ============================================================================
# Workflow: Security
# ============================================================================
# Purpose:
#   Runs comprehensive security analysis on the codebase to detect
#   vulnerabilities, security issues, and code quality problems.
#
# Security Tools:
#   - Bandit: Static analysis for common security issues in Python code
#   - pip-audit: Audits Python packages for security vulnerabilities (OSV database)
#   - CodeQL: GitHub's semantic code analysis engine for security and quality
# Note: Dependency updates and security alerts handled by Renovate
#
# Triggers:
#   - Push to main or develop branches
#   - Pull requests targeting main or develop branches
#   - Weekly schedule: Every Monday at 2:00 AM UTC
#
# Behavior:
#   - Fails the workflow if HIGH severity issues are found
#   - Generates detailed workflow summary with scan results
#   - Uploads security reports as artifacts only when issues are detected
# ============================================================================
name: Security

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 2 * * 1" # Weekly on Monday at 2 AM UTC

# Concurrency: Prevents multiple security scans from running simultaneously
# on the same branch/PR. When a new commit is pushed, any in-progress scan for
# that branch/PR is cancelled to save CI resources and reduce wait time.
# Uses PR number for pull_request events to avoid canceling unrelated PRs.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true  # Cancel older runs when new push occurs

jobs:
  # --------------------------------------------------------------------------
  # Job: security-scan
  # --------------------------------------------------------------------------
  # Runs Python security scanning tools (Bandit, pip-audit) to detect
  # security vulnerabilities in source code and dependencies. Generates a
  # detailed workflow summary and uploads reports when issues are found.
  # --------------------------------------------------------------------------
  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Prevents hanging jobs (typical runtime: 30-60 seconds)

    # Permissions: Minimal required access for security scanning
    permissions:
      contents: read    # Read repository code
      packages: read    # Read package registry (for dependency resolution)
      actions: read     # Read workflow artifacts

    steps:
      - name: Record job start time
        id: job-start
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Set up Python 3.12
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      # Bandit: Static analysis security testing (SAST) for Python
      # Scans source code for common security issues like SQL injection,
      # hardcoded passwords, insecure temp file usage, etc.
      - name: Run Bandit security scan
        run: bandit -r src/ -f json -o bandit-report.json

      # pip-audit: Audits Python packages for known vulnerabilities using OSV database
      # Generates both JSON (for parsing) and text (for human reading) reports
      # Error handling: Allows report generation even when vulnerabilities are found
      - name: Run pip-audit check (JSON)
        run: |
          # Allow report generation even with vulnerabilities; security-check step will evaluate
          pip-audit --format json > pip-audit-report.json || {
            echo "pip-audit returned non-zero exit code"
            exit 0
          }
        continue-on-error: false

      - name: Run pip-audit check (text)
        run: |
          # Allow report generation even with vulnerabilities; security-check step will evaluate
          pip-audit --desc > pip-audit-report.txt || {
            echo "pip-audit text scan completed with findings"
            exit 0
          }
        continue-on-error: false

      # Security Check Script: Aggregates results from all security tools
      # and generates a comprehensive workflow summary. Fails the workflow
      # if any HIGH severity issues or vulnerabilities are detected.
      #
      # Summary Format:
      #   - âœ… Tool: Status (when no issues found)
      #   - âŒ Tool: Issues found (when vulnerabilities detected)
      #   - ðŸš¨ Final status (failure if any issues found)
      #
      # Exit Code: 1 if security issues detected, 0 otherwise
      - name: Check for critical security issues
        id: security-check
        run: |
          set -euo pipefail  # Exit on error, undefined variable, or pipe failure
          IFS=$'\n\t'        # Set field separator for safe iteration

          ISSUES_FOUND=0  # Flag to track if any security issues were detected

          # Initialize workflow summary with header
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check Bandit results: Only HIGH severity issues cause workflow failure
          # (MEDIUM and LOW are informational only)
          if [ -f bandit-report.json ]; then
            HIGH_ISSUES=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json)
            if [ "$HIGH_ISSUES" -gt 0 ]; then
              echo "### âŒ Bandit: Found $HIGH_ISSUES HIGH severity issues" >> $GITHUB_STEP_SUMMARY
              echo "âŒ Found $HIGH_ISSUES HIGH severity security issues in Bandit scan"
              echo "High severity issues found:"
              jq -r '.results[] | select(.issue_severity == "HIGH") | "- \(.issue_text) in \(.filename):\(.line_number)"' bandit-report.json | tee -a $GITHUB_STEP_SUMMARY
              ISSUES_FOUND=1
            else
              echo "### âœ… Bandit: No HIGH severity issues" >> $GITHUB_STEP_SUMMARY
              echo "âœ… No HIGH severity issues found in Bandit scan"
            fi
          fi

          # Check pip-audit results: Counts total vulnerabilities across all dependencies
          # Any vulnerability (regardless of severity) is reported in the summary
          if [ -f pip-audit-report.json ]; then
            TOTAL_VULNS=$(jq '[.dependencies[].vulns[]] | length' pip-audit-report.json 2>/dev/null || echo "0")
            if [ "$TOTAL_VULNS" -gt 0 ]; then
              echo "### âŒ pip-audit: Found $TOTAL_VULNS vulnerabilities" >> $GITHUB_STEP_SUMMARY
              echo "âŒ Found $TOTAL_VULNS vulnerabilities in pip-audit scan"
              echo "Vulnerabilities found:" | tee -a $GITHUB_STEP_SUMMARY
              jq -r '.dependencies[].vulns[] | "- \(.id): \(.description // "No description")"' pip-audit-report.json 2>/dev/null | head -20 | tee -a $GITHUB_STEP_SUMMARY
              ISSUES_FOUND=1
            else
              echo "### âœ… pip-audit: No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "âœ… No vulnerabilities found in pip-audit scan"
            fi
          fi

          # Generate final summary based on aggregated results
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$ISSUES_FOUND" -eq 1 ]; then
            # Fail the workflow: Security issues require attention
            echo "### ðŸš¨ Security Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "Please review the security reports and address the findings." >> $GITHUB_STEP_SUMMARY
            exit 1  # Non-zero exit code fails the workflow
          else
            # Success: No security issues detected
            echo "### âœ… All Security Checks Passed" >> $GITHUB_STEP_SUMMARY
          fi

      # Artifact Upload: Only uploads security reports when security-check step fails
      # This saves storage costs by not uploading reports when all checks pass.
      # Reports are kept for 30 days to allow investigation of security issues.
      # Uses specific step outcome to avoid uploading on unrelated failures
      # (e.g., dependency installation failures).
      #
      # Uploaded artifacts include:
      #   - bandit-report.json: Detailed Bandit findings
      #   - pip-audit-report.json: Structured vulnerability data
      #   - pip-audit-report.txt: Human-readable vulnerability descriptions
      - name: Upload security reports
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: steps.security-check.conclusion == 'failure'  # Upload only when security issues detected
        with:
          name: security-reports
          path: |
            bandit-report.json
            pip-audit-report.json
            pip-audit-report.txt
          retention-days: 30  # Keep reports for 30 days

  # --------------------------------------------------------------------------
  # Job: codeql
  # --------------------------------------------------------------------------
  # Runs GitHub's CodeQL semantic code analysis engine to detect security
  # vulnerabilities, bugs, and code quality issues. CodeQL uses advanced
  # queries to find potential problems that traditional linters might miss.
  #
  # Results are uploaded to GitHub Security tab for tracking and remediation.
  # --------------------------------------------------------------------------
  codeql:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevents hanging jobs (typical runtime: 2-3 minutes)

    # Permissions: Required for CodeQL to upload analysis results
    permissions:
      actions: read          # Read workflow artifacts
      contents: read         # Read repository code
      security-events: write # Write security analysis results to GitHub Security

    # Matrix Strategy: Allows scanning multiple languages independently
    # Currently configured for Python only, but can be extended for other languages
    strategy:
      fail-fast: false  # Continue scanning even if one language fails
      matrix:
        language: ["python"]  # Languages to analyze (extensible to js, go, etc.)

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # Initialize CodeQL: Sets up the CodeQL analysis environment
      # and prepares the database for semantic code analysis.
      # Uses custom configuration for enhanced security coverage.
      # The config file specifies both security-extended and security-and-quality query suites.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml

      # NOTE: Python dependency installation removed - not needed for CodeQL analysis.
      # CodeQL for Python analyzes source code directly without requiring runtime
      # dependencies to be installed. This optimization reduces analysis time by ~30%
      # (saves approximately 21 seconds per run).
      #
      # For Python, CodeQL:
      # - Extracts the Abstract Syntax Tree (AST) from source code
      # - Builds a semantic database of code structure
      # - Runs security queries against this database
      # - Does NOT need imports to be resolvable or packages installed

      # Perform Analysis: Runs CodeQL queries and uploads results to GitHub Security
      # Results can be viewed in the Security > Code scanning alerts tab
      - name: Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@4e94bd11f71e507f7f87df81788dff88d1dacbfb # v4.31.0
        with:
          category: "/language:${{matrix.language}}"  # Categorize results by language
          upload: true  # Upload SARIF results to GitHub Security tab

      # Report CodeQL Analysis Results: Provides visibility into the CodeQL
      # scanning process and confirms successful analysis completion
      - name: Report CodeQL analysis results
        if: steps.analyze.outcome == 'success'
        run: |
          echo "## CodeQL Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Language:** ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
          echo "**Query Suites:** security-extended, security-and-quality" >> $GITHUB_STEP_SUMMARY
          echo "**Config:** .github/codeql/codeql-config.yml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results have been uploaded to the Security tab." >> $GITHUB_STEP_SUMMARY
          echo "Check: [Code scanning alerts](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Optimization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CodeQL analysis optimized by removing unnecessary dependency installation." >> $GITHUB_STEP_SUMMARY
          echo "**Performance improvement:** ~30% faster (saves ~21 seconds per run)" >> $GITHUB_STEP_SUMMARY
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Workflow failed - check logs for details"
          echo "## âŒ Workflow Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow has failed. Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
